<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
	<link rel="shortcut icon" href="./img/favicon.ico" type="image/x-icon">
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>Homebrew Chat Member Map</title>
  	<link href="https://stackpath.bootstrapcdn.com/bootswatch/4.1.1/superhero/bootstrap.min.css" rel="stylesheet">
  	<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.45.0/mapbox-gl.css' rel='stylesheet' />
  		<!--[if lte IE 8]>
  			<link href='http://api.tiles.mapbox.com/mapbox.js/v1.4.0/mapbox.ie.css' rel='stylesheet'>
  		<![endif]-->
  	<style>
		.starter-template {
  			padding: 10px 15px 0px;
  			text-align: center;
  		}
		.jumbotron {
			padding: 10px 15px 10px;
		}
  		.submit-template {
  			padding: 5px 15px 0px;
  			text-align: center;
  		}
  		#map {
  			height:400px;
  			width:100%;
  		}
		.mapboxgl-canvas {
			position: relative !important;
		}
  		#centerpoint {
  			display: none;
  			width: 128px;
  			height: 128px;
  			background: transparent url(img/crosshair.png) 0 0 no-repeat scroll;
  			overflow: visible;
  			position: absolute;
  			top: 50%;
  			left: 50%;
  			margin: -64px 0 0 -64px;
  			pointer-events: none;
  			z-index: 11;
  			opacity: 1;
  			-webkit-transition: opacity 0.25s;
  			-moz-transition: opacity 0.25s;
  			-o-transition: opacity 0.25s;
  			-ms-transition: opacity 0.25s;
  			transition: opacity 0.25s;
  		}
        img.resize {
            max-width:5%;
            max-height:5%;
        }
  	</style>
</head>
<body>
	<!--ADD THE FORM EMBEDURL BELOW-->
	<meta itemprop="embedUrl" content="https://docs.google.com/forms/d/1OskkCYjZLAdo-2bEeSBqEQNmweLtXmrJOOUGpZg8eMo/viewform?embedded=true">

	<!--ADD THE FORM RESPONSE ACTION HERE, WITH A REDIRECT-->
	<script type="text/javascript">var submitted=false;</script>
	<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(submitted) {window.location='./results/';}"></iframe>
	<form action="https://docs.google.com/forms/d/1OskkCYjZLAdo-2bEeSBqEQNmweLtXmrJOOUGpZg8eMo/formResponse" method="POST" id="ss-form" target="hidden_iframe" onsubmit="submitted=true;">
		<div class="container">
			<div class="jumbotron starter-template">
				<h1><img class="resize" src="img/hbclogo.png"  alt="HBC"> Homebrew Chat Member Map <img class="resize" src="img/hbclogo.png"  alt="HBC"></h1>
			</div>
			<div class="starter-template">
				<h2><em>(1) </em>Where you at?<h2>
				<p><small>Drag the map to center the marker on your general location</small></p>
				<div id="map">
					<span id="centerpoint" class="" style="display: inline;">
						<span class="shadow"></span>
						<span class="x"></span>
						<span class="marker"></span>
					</span>
				</div>
				<div class="starter-template">
					<h2><em>(2) </em>What's your homebrew chat handle?<h2>
					<input class="form-control" name="entry.1916041296" value="" id="entry_1916041296" placeholder="Username">
				</div>
				<!-- ADD GOOGLEFORM-RELATED INPUTS HERE, ALL HIDDEN.
				THEY'LL BE GIVEN VALUES IN THE SCRIPT BELOW
				THE "NAME" AND "ID" PARAMETERS MUST CORRESPOND TO
				THOSE IN THE SOURCE OF THE GOOGLE-HOSTED LIVE FORM-->

				<!-- QUESTION 2: LNG/LAT -->
				<input type="hidden" name="entry.1984352115" value="" id="entry_1984352115">
				<input type="hidden" name="entry.2119658880" value="" id="entry_2119658880">

				<!-- PAGE STUFF -->
				<input type="hidden" name="pageNumber" value="0">
				<input type="hidden" name="backupCache" value="">
			</div>
			<div class="submit-template">
				<h2>That's it! Thanks!<h2>
				<input type="submit" name="submit" value="Submit" class="btn-lg btn-success">
				<div class="starter-template">
					<h6>Take me to the <a href="results/" title="map">map</a> already, damn it!</h6>
				</div>
				<!-- Attribution
				a repurposed @vtcraghead joint, modified by @dmofot
				-->
			</div>
		</div>
	</form>

	<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js"></script>
	<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.45.0/mapbox-gl.js'></script>
	<script type='text/javascript'>
		// Set default location in case the IP doesn't have one
		var x = -95.71289;
		var y = 37.09024;
		var z = 8;
		$('#entry_1984352115').attr('value', x);
		$('#entry_2119658880').attr('value', y);

		// Build the map
		mapboxgl.accessToken = 'pk.eyJ1IjoiZG1vZm90IiwiYSI6IjMyODFmMjkwYTQ1NjUxYTEzOWYwOGZlMTMxY2FjZThiIn0.eNpL_ksyAN2Tcy5UeLqhyQ';
		var map = new mapboxgl.Map({
			container: 'map',
			style: 'mapbox://styles/mapbox/streets-v9',
			center: [x, y],
			zoom: z,
			maxBounds: [[-180, -90], [180, 90]],
			attributionControl: false
		});
		map.addControl(new mapboxgl.NavigationControl()).addControl(new mapboxgl.AttributionControl({ compact: true }));

		// Update these values as the map gets dragged around
		map.on('moveend', function(event) {
			$('#entry_1984352115').attr('value', map.getCenter().lng);
			$('#entry_2119658880').attr('value', map.getCenter().lat);
		});

		// If no in browser geolocation, grab IP location from geoip-db API
		if (!navigator.geolocation){
			$.getJSON('https://www.geoip-db.com/json/', function(json) {
				if (json) {
					x = json.longitude;
					y = json.latitude;
					// Set form lng/lat fields from map center location
					$('#entry_1984352115').attr('value', x);
					$('#entry_2119658880').attr('value', y);
					console.log("# No in browser geolocation, using geoip-db API.")
					map.flyTo({
						center: [x, y]});
				}
			})
		} else {
			// or use in browser geolocation
			navigator.geolocation.getCurrentPosition(function(position) {
				x = position.coords.longitude;
				y = position.coords.latitude;
				console.log("# Using in browser geolocation.")
				map.flyTo({
					center: [x, y]});
			}, function error() {
				$.getJSON('https://www.geoip-db.com/json/', function(json) {
					if (json) {
						x = json.longitude;
						y = json.latitude;
						// Set form lng/lat fields from map center location
						$('#entry_1984352115').attr('value', x);
						$('#entry_2119658880').attr('value', y);
						console.log("# Failed to use in browser geolocation, using geoip-db API.")
						map.flyTo({
							center: [x, y]});
					}
				})
			}, {timeout:3000})
		};
	</script>
</body>
</html>
